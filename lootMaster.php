<?php//@todo Full function page to manage raiders (change names, external status, class code).require("./functions.php");if(!isLoggedIn()){	if(isset($_POST['pass']))	{		if($_POST['pass'] == "fearhogger")		{			$_SESSION['status'] = 1;			showLootMasterMenu();					}		else		{			showLogin(true);		}	}	else	{		showLogin(false);	}	}else{	$h = new HttpQueryString();	switch($h->get("a"))	{		case "logout":			$_SESSION['status'] = 0;			session_unset();			header("Location: ./index.html");			break;		case "entry":			entryForm();			break;		case "submitNewEntry":			handleNewEntrySubmit();			break;		case "addRaider":			addRaiderForm();			break;		case "submitNewRaider":			handleNewRaider();			break;                case "massLootEntry":                        massLootEntryForm();                        break;                case "handleMassEntry":                        handleMassEntry();                        break;		default:			showLootMasterMenu();	}	}function showLogin($lastLoginFailed){	head();	echo "<form method=\"POST\" action=\"./lootMaster.php\" id=\"frmLogin\">\n";	echo "<table border=\"0\"><tr><td>";	echo "<td><b>Login:&nbsp;</b><input id=\"password\" type=\"password\" name=\"pass\" /></td>\n";echo <<< EOF<td><a href="#" class="smallNavigation" onclick="document.getElementById('frmLogin').submit();">Login</a></td><td><a href="index.html" class="smallNavigation">Cancel</a></td>EOF;	echo "</tr></table></form>";	echo "<script type=\"text/javascript\">document.getElementById('password').focus();</script>";	tail();}function showLootMasterMenu(){	head();	echo "<h2>Loot Master Menu</h2>";$h = new HttpQuerystring();if($h->get("s") != ""){    $color = "";    $message = "";    if($h->get("s") == "0")    {        $message = "Success";        $color = "green";    }    else if ($h->get("s") == "1")    {        $message = "Failed";        $color = "red";    }    if($color != "")    {        echo "<h3 style=\"color:$color\">$message</h3>\n";    }}	echo <<< EOF<div id="navigation"> <table border="0"><tr><td><a href="./lootMaster.php?a=entry" id="btnLootEntry">Loot <u><b>E</b></u>ntry</a></td></tr><tr><td><a href="./lootMaster.php?a=massLootEntry" id="btnMassLootEntry">Mass Loot Entry</a></td></tr><tr><td><a href="./lootMaster.php?a=addRaider" id="btnAddRaider"><u><b>A</b></u>dd Raider</a></td></tr><tr><td><a href="./manageRaiders.php?a=sync" id="btnSyncMembers"><u><b>S</b></u>ync From Armory</a></td></tr><tr><td><a href="./index.html" id="btnMainMenu"><u><b>M</b></u>ain Menu</a></td></tr><tr><td><a href="./lootMaster.php?a=logout" id="btnLogOut"><u><b>L</b></u>og Out</a></td></tr></table></div>EOF;		echo "<script type=\"text/javascript\">";	echo "registerShortcut(\"E\".charCodeAt(0),\"btnLootEntry\");\n";	echo "registerShortcut(\"M\".charCodeAt(0),\"btnMainMenu\");\n";	echo "registerShortcut(\"L\".charCodeAt(0),\"btnLogOut\");\n";	echo "registerShortcut(\"e\".charCodeAt(0),\"btnLootEntry\");\n";	echo "registerShortcut(\"m\".charCodeAt(0),\"btnMainMenu\");\n";	echo "registerShortcut(\"l\".charCodeAt(0),\"btnLogOut\");\n";        echo "registerShortcut(\"S\".charCodeAt(0),\"btnSyncMembers\");\n";        echo "registerShortcut(\"s\".charCodeAt(0),\"btnSyncMembers\");\n";	echo "</script>";		tail();}function entryForm(){	head();	echo "<h2>Loot Win Entry</h2>";	echo "<form action=\"./lootMaster.php?a=submitNewEntry\" method=\"post\" id=\"frmLootEntry\">\n";	echo "<table border=\"0\">\n";	echo "<tr><td>Character</td><td>\n<select name=\"character\" id=\"character\" >\n";	$c = getConnection();	$q = "SELECT DISTINCT CharacterName FROM PLAYER";	$r = mysql_query($q,$c);	while($m = mysql_fetch_array($r, MYSQL_ASSOC))	{		echo "\t<option value=\"" . $m['CharacterName'] . "\">" . $m['CharacterName'] . "</option>\n";	}	echo "</select>\n</td></tr>\n";	echo "<tr><td>ItemID</td><td><input type=\"text\" name=\"itemid\" maxlength=\"5\" size=\"7\" id=\"itemid\" onblur=\"onItemIDBlur();\" />&nbsp;<input type=\"button\" value=\"Look Up\" onClick=\"javascript:invokeItemLookUp();\" /></td></tr>\n";	echo "<tr><td></td><td><input type=\"text\" name=\"itemname\" maxlength=\"40\" id=\"itemname\" style=\"background-color:#CCCCCC;\" readOnly=\"true\" />";	echo "<img id=\"imgItemNameLoading\" src=\"./images/loading.gif\" height=\"15\" width=\"15\" onload=\"hideItemNameLoading();\" /></td></tr>\n";	echo "<tr><td>Date Won</td><td><input type=\"text\" name=\"date\" maxlength=\"10\" size=\"10\" id=\"date\" />&nbsp;(YYYY-MM-DD)</td></tr>\n";	echo "<tr><td><a class=\"smallNavigation\" href=\"lootMaster.php\" id=\"btnCancel\" >Cancel</a></td>\n" .			"<td><a class=\"smallNavigation\" href=\"#\" onclick=\"document.getElementById('frmLootEntry').submit();\">Submit</a></td></tr>\n";	echo "</table></form>";		echo "<script type=\"text/javascript\">";	echo "var d = new Date();\n";	echo "document.getElementById(\"date\").value=d.getFullYear().toString() + \"-\" + (d.getMonth()+1).toString() + \"-\" + d.getDate().toString();\n";	echo "document.getElementById(\"character\").focus();\n";	echo "</script>\n";		tail();}function massLootEntryForm(){head();echo <<< EOF<h2>HeadCount Loot XML</h2><form method="post" action="./lootMaster.php?a=handleMassEntry"><textarea id="txtLootXML" name="txtLootXML" cols="60" rows="20"></textarea><br /><input type="button" value="Cancel" onClick="javascript:history.go(-1);" />&nbsp;<input type="submit" id="btnSubmit" value="Submit" /></form><script language="javascript">document.getElementById("txtLootXML").focus();</script>EOF;tail();}function handleMassEntry(){    $raid = @(new SimpleXMLElement(utf8_encode($_POST['txtLootXML'])));    $date = (string)$raid->key;    $dt = explode(" ",$date);    $date = $dt[0];    $parts = explode("/",$date);    foreach($raid->Loot->children() as $lootwin)    {        if(!playerInDatabase($lootwin->Player))        {            #echo "Player $lootwin->Player not currently in the database. Adding...<br />\n";            foreach($raid->PlayerInfos->children() as $player)            {                if((string)$player->name == (string)$lootwin->Player)                {                    $q = "INSERT INTO PLAYER VALUES ('$player->name',";                    $q .= (((string)$player->Guild == (string)$guild) ? "1" : "0") . ",'" . classNameToCode((string)$player->class) . "');";                    $r = mysql_query($q, getConnection());                    if(mysql_error())                    {                        head();                        echo "&nbsp;&nbsp;FAILED to add the new raider into the database.<br />\n";                        backButton();                        tail();                        return false;                    }                }            }        }        $q = "INSERT INTO LOOTWIN (LootWinDate,CharacterName,LootItemID,LootItemName) VALUES ('";        $q .= "$parts[2]-$parts[0]-$parts[1]" . "','" . $lootwin->Player . "','" . $lootwin->ItemID . "','" . $lootwin->ItemName . "');";        $r = mysql_query($q, getConnection());        if(!$r)        {            head();            echo "&nbsp;&nbsp;FAILED to add the win of $lootwin->ItemName by $lootwin->Player.<br />\n";            backButton();            tail();            return false;        }    }    header("Location: ./lootMaster.php");}function handleNewEntrySubmit(){	$q = "INSERT INTO USER.LOOTWIN";	$q .= "(CharacterName,LootItemID,LootItemName,LootWinDate)";	$q .= " VALUES ";	$q .= "('" . cleanSQLString($_POST['character']) . "','" .		 cleanSQLString($_POST['itemid']) . "','" .		 cleanSQLString($_POST['itemname']) . "','" .		 cleanSQLString($_POST['date']) . "');";		 	$c = getConnection();	$r = mysql_query($q,$c);	if(!$r)	{		header("Location: ./lootMaster.php?s=1");		//echo mysql_error();		//echo "\n$q";	}	else	{		header("Location: ./lootMaster.php?s=0");	}}function addRaiderForm(){head();echo <<< EOF<h2>Add Raider</h2><form id="frmAddRaider"><table border="0">	<tr><td>Character Name</td><td><input type="text" id="txtCharacterName" /></td></tr>	<tr><td>Class</td>		<td>			<select id="selClass">				<option value="1">Warrior</option>				<option value="2">Paladin</option>				<option value="3">Hunter</option>				<option value="4">Rogue</option>				<option value="5">Priest</option>				<option value="6">Death Knight</option>				<option value="7">Shaman</option>				<option value="8">Mage</option>				<option value="9">Warlock</option>				<option value="11">Druid</option>			</select>		</td>	</tr>	<tr>		<td><a class="smallNavigation" href="lootMaster.php" id="btnCancel" >Cancel</a></td>		<td><a class="smallNavigation" href="#" onclick="doAddRaiderSubmit();">Submit</a></td>	</tr></table></form><script type="text/javascript">document.getElementById("txtCharacterName").focus();</script>EOF;tail();}?>